# Sessions: 2026-01-28

**Summary:** File storage migration to data/

---

## Session 1: Migrate File Storage to data/ Directory

**Duration:** ~15 minutes
**Status:** Complete

### System Flow

```
Before:
apps/api/assets/input/{workflowId}/*.jpg  →  File uploads
apps/api/assets/output/{workflowId}/*.mp4 →  Generated outputs

After:
data/{workflowId}/input/*.jpg   →  File uploads
data/{workflowId}/output/*.mp4  →  Generated outputs
```

### What was done

- [x] Updated `.gitignore` to ignore `data/*` except `.gitkeep`
- [x] Created `data/` directory structure with workflow subdirectories
- [x] Moved existing files from `apps/api/assets/input/697a2638c578f6a2ba9e1c8c/` to `data/697a2638c578f6a2ba9e1c8c/input/`
- [x] Created `data/.gitkeep` for fresh clones
- [x] Removed old `apps/api/assets/` directory
- [x] Verified gitignore correctly ignores workflow data

### Files changed

- `.gitignore` - Simplified rules: `data/*` ignored, `!data/.gitkeep` preserved
- `data/.gitkeep` - Created (empty file for git tracking)
- `data/697a2638c578f6a2ba9e1c8c/input/` - Created with migrated files

### Files deleted

- `apps/api/assets/` - Entire directory removed (files moved to `data/`)

### Decisions

- **Decision:** Use flat `data/{workflowId}/` structure instead of nested `data/workflows/{workflowId}/`
  - **Context:** Simplifies path construction and matches common patterns
  - **Rationale:** Fewer path segments, easier to work with

- **Decision:** Single `.gitkeep` at root instead of per-subdirectory
  - **Context:** Git will create subdirectories when files are added
  - **Rationale:** Minimizes tracked files, clean repository

### Verification

- Files moved: 2 images confirmed in `data/697a2638c578f6a2ba9e1c8c/input/`
- Gitignore working: Only `data/.gitkeep` tracked, workflow data ignored

### Next steps

- [x] Update `files.service.ts` to use new `data/` path instead of `apps/api/assets/`
- [x] Update any hardcoded paths in processors
- [ ] Test file upload/download with new paths

---

## Session 2: Image Node UX & Local File Storage Implementation

**Duration:** ~1 hour
**Status:** Complete

### System Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Local File Storage Flow                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  UPLOAD (Input Files):                                                   │
│  ┌──────────┐    POST /api/files/workflows/{id}/input/{type}            │
│  │ Frontend │ ──────────────────────────────────────────────►           │
│  │  Upload  │                                                           │
│  └──────────┘    ┌─────────────────────────────────────────────┐        │
│                  │ data/workflows/{workflowId}/input/          │        │
│                  │   └── image-{ts}-{hash}.jpg                 │        │
│                  └─────────────────────────────────────────────┘        │
│                                                                          │
│  AUTO-SAVE (Generated Outputs):                                          │
│  ┌──────────┐    Download from    ┌──────────────────────────┐          │
│  │Processor │ ───────────────────►│ Replicate Output URL     │          │
│  │(img/vid) │                     └──────────────────────────┘          │
│  └──────────┘                                │                          │
│       │                                      │                          │
│       │    Save to local                     ▼                          │
│       └──────────────────►  ┌─────────────────────────────────┐         │
│                             │ data/workflows/{workflowId}/output/│       │
│                             │   └── {nodeId}-{ts}.jpg          │        │
│                             └─────────────────────────────────┘         │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### What was done

- [x] Fixed replay button positioning in ImageGenNode (changed from `object-contain` to `object-cover` with `aspect-[4/3]`)
- [x] Updated FilesService to use `data/workflows/{id}/` paths
- [x] Added `saveWorkflowOutput()` and `downloadAndSaveOutput()` methods to FilesService
- [x] Updated all API routes from `/api/files/input/` to `/api/files/workflows/{id}/input/`
- [x] Added auto-save functionality to image.processor.ts, video.processor.ts, processing.processor.ts
- [x] Removed Output node from node palette (kept in types for backwards compatibility)
- [x] Updated frontend upload endpoints to match new API paths

### Files changed

**Frontend:**
- `apps/web/src/components/nodes/ai/ImageGenNode.tsx` - Fixed image container sizing (aspect-[4/3], object-cover)
- `apps/web/src/components/nodes/input/ImageInputNode.tsx` - Updated upload endpoint path
- `apps/web/src/components/nodes/input/VideoInputNode.tsx` - Updated upload endpoint path
- `apps/web/src/components/nodes/index.ts` - Added deprecation comment for OutputNode
- `apps/web/src/components/panels/NodePalette.tsx` - Filter out empty categories
- `apps/web/src/components/context-menu/menus/paneMenu.tsx` - Filter out empty categories
- `apps/web/src/lib/api/client.ts` - Updated documentation comment

**Backend:**
- `apps/api/src/services/files.service.ts` - New storage paths + saveWorkflowOutput() + downloadAndSaveOutput()
- `apps/api/src/controllers/files.controller.ts` - Updated routes to new structure
- `apps/api/src/processors/image.processor.ts` - Added auto-save after generation
- `apps/api/src/processors/video.processor.ts` - Added FilesService injection + auto-save
- `apps/api/src/processors/processing.processor.ts` - Added FilesService injection + auto-save
- `apps/api/src/queue/queue.constants.ts` - Removed 'output' from PASSTHROUGH_NODE_TYPES

**Types:**
- `packages/types/src/nodes.ts` - Marked output node deprecated, removed from NODE_ORDER

### Decisions

- **Decision:** Keep output node type for backwards compatibility but hide from UI
  - **Context:** Existing workflows may have Output nodes, would break if type removed
  - **Rationale:** Graceful degradation - old workflows still work, new ones don't show Output

- **Decision:** Auto-save continues workflow even if local save fails
  - **Context:** Remote URL still works even if local save fails
  - **Rationale:** Non-blocking - better UX to complete workflow than fail on optional feature

- **Decision:** Use `data/workflows/{workflowId}/` structure
  - **Context:** Need organized storage per workflow for both inputs and outputs
  - **Rationale:** Better organization, easier cleanup, clearer ownership of files

### Mistakes and fixes

- None encountered

### Next steps

- [ ] Test file upload with new endpoints
- [ ] Test image generation with auto-save
- [ ] Verify Output node no longer appears in palette
- [ ] Consider adding cleanup job for old workflow data

---

## Session 3: Template Thumbnail Images

**Duration:** ~5 minutes
**Status:** Complete

### System Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Template Thumbnail Display                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Before:                                                                 │
│  ┌──────────────┐                                                        │
│  │ Templates    │     WorkflowPreview                                   │
│  │ Modal        │ ──► (renders node graph)                              │
│  └──────────────┘                                                        │
│                                                                          │
│  After:                                                                  │
│  ┌──────────────┐     ┌──────────────────────────────────┐              │
│  │ Templates    │ ──► │ Unsplash CDN Image               │              │
│  │ Modal        │     │ (600x400, 3:2 aspect ratio)      │              │
│  └──────────────┘     └──────────────────────────────────┘              │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### What was done

- [x] Added `thumbnail` property to all 13 templates in TEMPLATE_INFO array
- [x] Used curated Unsplash images matching each template's purpose
- [x] Applied consistent sizing via URL params (`w=600&h=400&fit=crop`)

### Files changed

- `apps/web/src/templates/index.ts` - Added thumbnail URLs to all 13 template entries

### Template Thumbnails Added

| Template | Image Concept |
|----------|---------------|
| image-series | Photo grid/gallery |
| image-to-video | Film/motion |
| full-pipeline | Data pipeline/workflow |
| extended-video | Film reel |
| grid-to-video | Grid/mosaic pattern |
| voice-to-video | Microphone/audio |
| youtube-thumbnail-script | YouTube branding |
| youtube-video-generator | Video production |
| stream-to-social | Live streaming |
| social-brand-kit | Social media branding |
| facecam-avatar | Portrait/face |
| dance-video | Dancing/motion |
| instagram-carousel | Instagram aesthetic |

### Decisions

- **Decision:** Use Unsplash CDN URLs directly instead of local images
  - **Context:** TemplateInfo already had optional `thumbnail` field
  - **Rationale:** No build step needed, CDN handles caching/resizing, free license

### Next steps

- [ ] Verify thumbnails display correctly in templates modal
- [ ] Test that clicking templates still works with thumbnail

---

**Total sessions today:** 3
