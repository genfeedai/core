# Session: 2026-02-02

## Session 1: Document Core vs Cloud Scope Decisions

**Goal:** Codify scope decisions about what belongs in Core OSS vs Cloud SaaS, reflecting recent deletions (telegram-bot, CLI, SDK) and architectural choices (no webhooks, no bots, no scheduled triggers in core).

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| Telegram Bot → Cloud only | Core exposes no bot mechanism. Cloud owns TG bot at `cloud/apps/server/api/src/services/telegram-bot/` |
| No webhook triggers in core | Self-hosted core runs on localhost; external services can't reach it without tunnels |
| No cloudUpload node | Cloud outputs go to CDN automatically; no separate upload node needed |
| CLI and SDK removed | Already deleted from core. Docs updated to reflect this |
| Core is UI-triggered only | Workflows triggered exclusively from web UI "Run" button |

### Files Modified

| File | Change |
|------|--------|
| `.agents/SYSTEM/FEATURE-SPLIT.md` | Removed webhook triggers, scheduled execution, CLI from Core. Added Telegram Bot, Webhook triggers, Scheduled execution to Cloud SaaS table. Added guidelines #6 (no bot/trigger integrations) and #7 (no CLI/SDK). Updated date. |
| `.agents/skills/scope-validator/SKILL.md` | Added Cloud-Only Features table. Added Rule 5: Bot/Trigger Check. Added Telegram/webhook FAQ entries. Updated Quick Reference with cloud-only features and "Triggers: UI only" note. |
| `.agents/SYSTEM/ARCHITECTURE.md` | Added UI-only trigger note to data flow diagram. Fixed Output node categories (removed WebhookOutput, APIOutput). Replaced SDK package with actual packages (prompts, workflows). |
| `.agents/TASKS/INBOX.md` | Marked Telegram Bot task as moved to Cloud SaaS. Struck through Telegram bot reference in UGC Factory task. |

### Stale References Noted

Grep found webhook/telegram references in these files (left as-is since they're historical records):
- `.agents/SESSIONS/2026-01-21.md` — Session 22 documents the webhook removal process
- `.agents/SESSIONS/2026-01-14.md` — Historical webhook implementation
- `.agents/PRDS/telegram-bot-core.md` — Superseded PRD (core telegram bot was deleted)
- `.agents/PRDS/telegram-bot-workflow.md` — Original PRD, cloud portion still valid
- `.agents/PRDS/kling-motion-control.md` — References Replicate API webhooks (internal mechanism, not external triggers)
- `.agents/PRDS/ugc-factory-*.md` — Historical references to Telegram distribution

### Patterns Established

- Core scope docs now consistently state: **UI-only trigger model**
- Three-doc consistency: FEATURE-SPLIT, scope-validator SKILL, and ARCHITECTURE all align
- Cloud SaaS table in FEATURE-SPLIT is the authoritative scope boundary

---

## Session 2: Stop Tracking next-env.d.ts

**Goal:** Remove auto-generated `next-env.d.ts` files from git tracking in core repo (cloud already ignores them).

### Tasks Completed

1. Added `next-env.d.ts` to `.gitignore` under a new "Next.js auto-generated" section
2. Removed both tracked files from git index: `next-env.d.ts` and `apps/web/next-env.d.ts`
3. Committed as `3a5847e` — `chore: stop tracking next-env.d.ts`

### Files Modified

| File | Change |
|------|--------|
| `.gitignore` | Added `next-env.d.ts` to ignore list |
| `next-env.d.ts` | Removed from git tracking (file still exists locally) |
| `apps/web/next-env.d.ts` | Removed from git tracking (file still exists locally) |

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| Ignore pattern `next-env.d.ts` (no path prefix) | Catches all instances across the repo, matching cloud repo's approach |

### Status
- Committed, not pushed

---

## Session 3: Refactor Distribution Node Registry

**Goal:** Replace hardcoded distribution node injection with a `DistributionNodeRegistry` service. Remove concrete node coupling from `ProcessingProcessor`.

### Tasks Completed

1. Created `DistributionNodeRegistry` injectable service with `register()`, `get()`, `getRegisteredTypes()` methods
2. Updated 3 output nodes to self-register via `OnModuleInit` lifecycle hook
3. Simplified `queue.module.ts` — removed 3 string token aliases, added single registry provider + alias
4. Refactored `ProcessingProcessor` — replaced 3 concrete node injections with single registry injection, replaced switch-based lookup with registry lookup

### Files Created

| File | Purpose |
|------|---------|
| `apps/api/src/nodes/distribution/distribution-node-registry.ts` | Registry service — `Map<nodeType, { node, platform }>` |

### Files Modified

| File | Change |
|------|--------|
| `apps/api/src/nodes/distribution/telegram-output-node.ts` | Added `OnModuleInit`, injects registry, registers as `telegramPost` → `telegram` |
| `apps/api/src/nodes/distribution/discord-output-node.ts` | Added `OnModuleInit`, injects registry, registers as `discordPost` → `discord` |
| `apps/api/src/nodes/distribution/google-drive-output-node.ts` | Added `OnModuleInit`, injects registry, registers as `googleDriveUpload` → `google_drive` |
| `apps/api/src/modules/queue.module.ts` | Added `DistributionNodeRegistry` provider + string alias; removed 3 individual node aliases |
| `apps/api/src/processors/processing.processor.ts` | Replaced 3 node injections with single `DistributionNodeRegistry` injection; replaced switch with `registry.get()` |

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| Self-registration via `OnModuleInit` | Nodes own their registration — adding a new node = 1 file + 1 line in module providers |
| `forwardRef` on registry injection in nodes | Avoids circular dependency since registry and nodes are in the same module |
| Keep concrete nodes as providers in module | NestJS DI still needs to instantiate them for `OnModuleInit` to fire |
| Registry uses `Map<string, { node, platform }>` | Simple lookup, no switch statements, O(1) access |

### Patterns Established

- Distribution nodes self-register with `DistributionNodeRegistry` via `OnModuleInit`
- `ProcessingProcessor` has zero knowledge of concrete distribution node types
- Adding a new distribution platform = 1 new file (node with `OnModuleInit`) + 1 line in `queue.module.ts` providers

### Status
- All changes made, zero TS diagnostics
- Not committed, not pushed

---

## Session 4: Clean Stale Inbox Tasks

**Goal:** Mark completed inbox tasks as done and move to Processed section.

### Tasks Completed

1. Marked **UGC Factory Integration** as done — processing pipeline (TTS, lip sync, video stitch, reframe, upscale) is wired in `processing.processor.ts`, distribution nodes implemented via `DistributionNodeRegistry` (`5042aef`)
2. Marked **Replace direct LLM calls with provider abstraction** as done — provider selector in SettingsModal, `ProviderType` in use
3. Moved both to `## Processed` section under `### 2026-02-02`
4. Updated `Last Updated` date to `2026-02-02`

### Files Modified

| File | Change |
|------|--------|
| `.agents/TASKS/INBOX.md` | Marked 2 tasks as done, moved to Processed section, updated date |

### Status
- Inbox has zero open tasks
- Documentation updated

---

## Session 5: Investigate `apps/data/workflows` vs Root `data/`

**Goal:** Understand why `apps/data/workflows` exists when the real data directory is at the monorepo root `data/`.

### Investigation

1. Checked directory structure — found `apps/data/workflows/` (empty) and root `data/workflows/` (contains workflow data files with MongoDB ObjectId-style names)
2. Confirmed `apps/data/` has **no `package.json`** — not a valid workspace package
3. Confirmed `apps/data/workflows/` has **zero files**
4. Grep'd codebase for references:
   - `apps/api/src/services/files.service.ts` → references `/data/workflows/` (root-level)
   - `apps/web/src/app/api/gallery/[...path]/route.ts` → resolves `../../data/workflows` (root-level)
   - `apps/web/src/app/api/gallery/route.ts` → resolves `../../data/workflows` (root-level)
5. No code creates or references `apps/data/` — it's a stray empty directory (likely accidental drag in VS Code)

### Conclusion

| Finding | Detail |
|---------|--------|
| `apps/data/` is stray | Empty, no package.json, no code references it |
| Root `data/workflows/` is real | Contains actual workflow data, referenced by API and web apps |
| Safe to delete `apps/data/` | No runtime code creates or depends on it |

### Files Modified

None — investigation only, no changes made.

### Status
- Identified stray `apps/data/` directory — user can delete when ready

---

## Session 6: Full PRD + Task Audit Against Codebase

**Goal:** Cross-reference all 19 PRDs and 14 task files against actual implemented code. Identify stale statuses.

### Audit Results

**14 PRDs have wrong status** — code is shipped but PRD still says Planning/Doing/Backlog:

| PRD | Doc Status | Actual | Evidence |
|-----|-----------|--------|----------|
| `right-click-context-menu.md` | Doing | Done | `ContextMenu.tsx`, `useContextMenu.ts`, node/pane/edge/selection menus |
| `auto-save.md` | Planning | Done | `useAutoSave.ts` hook, `SaveIndicator.tsx` |
| `command-palette.md` | Planning | Done | `CommandPalette.tsx` (294 lines), `commandPaletteStore.ts` |
| `auto-reorder-blocks.md` | Planning | Done | `autoLayout.ts` (258 lines) with dagre, visible in context menu |
| `ai-quickstart-natural-language.md` | Ready for Implementation | Done | `WorkflowGeneratorService`, `GenerateWorkflowModal.tsx` |
| `kling-motion-control.md` | To Do | Done | `MotionControlNode.tsx` with all modes/quality/orientation |
| `image-annotation-editor.md` | Backlog | Done | `AnnotationModal.tsx`, `AnnotationNode.tsx`, Canvas API |
| `oss-rebrand.md` | Planning | Done | All packages `@genfeedai/*`, AGPL-3.0 license |
| `group-locking.md` | Doing | Done (buggy?) | `lockingSlice.ts`, `groupSlice.ts` in workflowStore |
| `test-coverage.md` | Doing | Done | 46 test files, vitest config, coverage thresholds set |
| `onboarding-modal.md` | Planning | Partial | `WelcomeModal.tsx` exists, no template gallery wizard |
| `ugc-factory-integration.md` | In Progress | Done | Pipeline wired in `processing.processor.ts` |
| `telegram-bot-core.md` | In Progress | Superseded | Bot removed from core (`747800b`), moved to Cloud |
| `telegram-bot-workflow.md` | In Progress | Superseded | Cloud-only, no bot in core |

**PRDs with correct status (3):**
- `avatar-workflow.md` — Implemented
- `workflow-cost-tracking.md` — Done (Phase 1 MVP)
- `input-group.md` — Complete
- `ugc-factory-prd.md` — Implemented

**Dead references in `PRDS/README.md`:**
5 marketplace PRDs linked but files don't exist (abandoned direction):
- `marketplace-overview.md`, `seller-system.md`, `listing-system.md`, `purchase-flow.md`, `reviews-ratings.md`

**Task files:** All 14 correctly show `Status: Done`.

### Remaining Work Identified

1. **Group locking** — user reports bugs, needs investigation
2. **Onboarding modal** — `WelcomeModal` exists but no template gallery/step-by-step wizard per PRD spec
3. **Stray `apps/data/`** — empty directory, safe to delete
4. **PRD status updates** — 14 PRDs need status corrected
5. **PRDS/README.md** — dead marketplace links need cleanup

### Files Modified

None — audit only, no changes made. User to decide on bulk PRD updates.

### Status
- Full audit complete
- Awaiting user decision on bulk PRD status updates

---

## Session 7: Bulk PRD Status Updates + README Cleanup

**Goal:** Update all 14 stale PRD statuses to match actual implementation state. Clean up PRDS/README.md.

### Tasks Completed

1. Updated 10 PRDs to **Done**: right-click-context-menu, auto-save, command-palette, auto-reorder-blocks, ai-quickstart-natural-language, kling-motion-control, image-annotation-editor, oss-rebrand, test-coverage, ugc-factory-integration
2. Updated group-locking to **Buggy — implemented but has reported issues, needs investigation**
3. Updated onboarding-modal to **Partial (WelcomeModal exists, template gallery wizard not implemented)**
4. Updated telegram-bot-core and telegram-bot-workflow to **Superseded** (moved to Cloud SaaS)
5. Rewrote `PRDS/README.md` — removed 5 dead marketplace links, reorganized into Done/Partial/Superseded sections, added all 18 PRDs to listing

### Files Modified

| File | Change |
|------|--------|
| `.agents/PRDS/right-click-context-menu.md` | Status: Doing → Done |
| `.agents/PRDS/auto-save.md` | Status: Planning → Done |
| `.agents/PRDS/command-palette.md` | Status: Planning → Done |
| `.agents/PRDS/auto-reorder-blocks.md` | Status: Planning → Done |
| `.agents/PRDS/ai-quickstart-natural-language.md` | Status: Ready for Implementation → Done |
| `.agents/PRDS/kling-motion-control.md` | Status: To Do → Done |
| `.agents/PRDS/image-annotation-editor.md` | Status: Backlog → Done |
| `.agents/PRDS/oss-rebrand.md` | Status: Planning → Done |
| `.agents/PRDS/test-coverage.md` | Status: Doing → Done |
| `.agents/PRDS/ugc-factory-integration.md` | Status: In Progress → Done |
| `.agents/PRDS/group-locking.md` | Status: Doing → Buggy |
| `.agents/PRDS/onboarding-modal.md` | Status: Planning → Partial |
| `.agents/PRDS/telegram-bot-core.md` | Status: Draft → In Progress → Superseded |
| `.agents/PRDS/telegram-bot-workflow.md` | Status: In Progress → Superseded |
| `.agents/PRDS/README.md` | Removed dead marketplace links, reorganized into Done/Partial/Superseded, added all PRDs, updated date |

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| group-locking status = "Buggy" not "Done" | User flagged — can't call it done if it has known issues |
| Removed marketplace section entirely | 5 linked files never existed, abandoned direction |
| Organized README by status category | Easier to scan what's done vs what needs work |

### Remaining Work

1. **Group locking bugs** — needs investigation
2. **Onboarding wizard** — WelcomeModal exists but template gallery not built
3. **Stray `apps/data/`** — empty directory, safe to delete

### Status
- All PRD statuses now reflect reality
- Not committed, not pushed

---

## Session 8: Codebase Optimization — DRY, Simplify, Optimize (12 Refactors)

**Goal:** Execute a comprehensive 4-phase optimization plan covering backend distribution nodes, processor simplification, frontend component DRY, and types/store cleanup. ~840 lines removed.

### Phase 1: Distribution Node DRY (Backend)

**1.1** — Extracted `deliverToTargets<TTarget>()` template method + `ensureBuffer()` into `BaseOutputNode`. Added `PlatformConfig` base interface. Fixed `DeliveryResult.results` from `any[]` to `Array<Record<string, unknown>>`.

**1.2** — Simplified Discord/Telegram `deliver()` from ~90 lines each to single `deliverToTargets()` calls. Fixed 6 `any` types: `getChannelInfo`, `getBotInfo`, `drive`, `getStorageInfo`, config generics.

**1.3** — Replaced 2 manual `updateProgress + addJobLog` pairs in ProcessingProcessor with `updateProgressWithLog()`.

### Phase 2: Processor Simplification (Backend)

**2.1** — Added `extractOutputUrl()` (6 Replicate output formats) + `saveAndNormalizeOutput()` to BaseProcessor. ~270 lines consolidated.

**2.2** — Added `startJob()` + `completeJob()` template methods to BaseProcessor.

**2.3-2.5** — Refactored `ImageProcessor`, `VideoProcessor`, `ProcessingProcessor` to use new base methods. Debug mode and heartbeat callbacks preserved.

### Phase 3: Frontend Component DRY

**3.1** — Created `Modal` (ESC key, backdrop, header) + `ModalTabs` reusable components.

**3.2** — Split SettingsModal (558→47 lines) into 5 tab files. ESC key bug fixed.

**3.3** — Extracted `ProcessingOverlay` component, replaced 5 copy-pasted overlay blocks.

**3.4** — Extracted `useAIGenNode` hook with 5 shared useMemo/useCallback blocks.

### Phase 4: Types & Store Cleanup

**4.1** — Split `nodes.ts` (2034 lines) into 11 modules under `packages/types/src/nodes/`. Fixed 2 `any` types in `WebhookPostNodeData`. Barrel re-export preserves API.

**4.2** — Added `setAndPersist()` helper to settingsStore, refactored 11 actions.

### Files Created (19)

| File | Purpose |
|------|---------|
| `apps/web/src/components/ui/modal.tsx` | Reusable Modal + ModalTabs |
| `apps/web/src/components/nodes/ProcessingOverlay.tsx` | Shared processing spinner overlay |
| `apps/web/src/hooks/useAIGenNode.ts` | Shared AI gen node schema hook |
| `apps/web/src/components/settings/tabs/DefaultsTab.tsx` | Settings defaults tab |
| `apps/web/src/components/settings/tabs/ApiKeysTab.tsx` | Settings API keys tab |
| `apps/web/src/components/settings/tabs/AppearanceTab.tsx` | Settings appearance tab |
| `apps/web/src/components/settings/tabs/DeveloperTab.tsx` | Settings developer tab |
| `apps/web/src/components/settings/tabs/HelpTab.tsx` | Settings help tab |
| `packages/types/src/nodes/handles.ts` | Handle types and connection rules |
| `packages/types/src/nodes/providers.ts` | Provider and model types |
| `packages/types/src/nodes/base.ts` | Base node types and status |
| `packages/types/src/nodes/input-nodes.ts` | Input node data interfaces |
| `packages/types/src/nodes/ai-nodes.ts` | AI node data interfaces |
| `packages/types/src/nodes/processing-nodes.ts` | Processing node data interfaces |
| `packages/types/src/nodes/distribution-nodes.ts` | Distribution node data interfaces |
| `packages/types/src/nodes/composition-nodes.ts` | Composition node data interfaces |
| `packages/types/src/nodes/union.ts` | WorkflowNodeData union + WorkflowNode/Edge |
| `packages/types/src/nodes/registry.ts` | NODE_DEFINITIONS registry |
| `packages/types/src/nodes/index.ts` | Barrel re-export |

### Files Modified (~15)

| File | Change |
|------|--------|
| `apps/api/src/nodes/distribution/base-output-node.ts` | Added PlatformConfig, ensureBuffer(), deliverToTargets() |
| `apps/api/src/nodes/distribution/discord-output-node.ts` | Simplified deliver(), fixed any types |
| `apps/api/src/nodes/distribution/telegram-output-node.ts` | Simplified deliver(), fixed any types |
| `apps/api/src/nodes/distribution/google-drive-output-node.ts` | Fixed drive: any, getStorageInfo: any |
| `apps/api/src/processors/base.processor.ts` | Added extractOutputUrl, saveAndNormalizeOutput, startJob, completeJob |
| `apps/api/src/processors/image.processor.ts` | Uses base methods |
| `apps/api/src/processors/video.processor.ts` | Uses base methods |
| `apps/api/src/processors/processing.processor.ts` | Uses updateProgressWithLog, base methods |
| `apps/web/src/components/settings/SettingsModal.tsx` | 558→47 lines |
| `apps/web/src/components/nodes/ai/ImageGenNode.tsx` | Uses ProcessingOverlay + useAIGenNode |
| `apps/web/src/components/nodes/ai/VideoGenNode.tsx` | Uses ProcessingOverlay + useAIGenNode |
| `apps/web/src/store/settingsStore.ts` | Added setAndPersist helper |
| `packages/types/src/index.ts` | `./nodes` → `./nodes/index` |

### Files Deleted (1)

| File | Reason |
|------|--------|
| `packages/types/src/nodes.ts` | Split into 11 modules |

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| `deliverToTargets()` generic template | Shared loop in base, platform-specific via callbacks |
| `filesService` as overridable getter (not abstract) | Not all processors need file saving |
| Standardized modal backdrop to `bg-black/50` | Most common existing pattern |
| Kept deprecated store re-exports | 82 files import from them; mass migration out of scope |
| `WebhookPostNodeData` any → `Record<string, unknown> \| null` | Last `any` in types package |

### Patterns Established

- Distribution nodes: `deliverToTargets()` template method
- Processors: `startJob()`/`completeJob()`/`saveAndNormalizeOutput()` from BaseProcessor
- Modals: Shared `Modal` component with ESC + optional `ModalTabs`
- AI gen nodes: `useAIGenNode` hook for schema logic
- Settings store: `setAndPersist()` for all state+persistence actions
- Types: Split by category in `nodes/` directory with barrel re-export

### Status
- All 12 refactors implemented across 4 phases
- Not committed, not pushed
- Needs verification: `bun run check`, `bun run build:api`, `bun run build:web`
