# Session: 2026-02-02

## Session 1: Document Core vs Cloud Scope Decisions

**Goal:** Codify scope decisions about what belongs in Core OSS vs Cloud SaaS, reflecting recent deletions (telegram-bot, CLI, SDK) and architectural choices (no webhooks, no bots, no scheduled triggers in core).

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| Telegram Bot → Cloud only | Core exposes no bot mechanism. Cloud owns TG bot at `cloud/apps/server/api/src/services/telegram-bot/` |
| No webhook triggers in core | Self-hosted core runs on localhost; external services can't reach it without tunnels |
| No cloudUpload node | Cloud outputs go to CDN automatically; no separate upload node needed |
| CLI and SDK removed | Already deleted from core. Docs updated to reflect this |
| Core is UI-triggered only | Workflows triggered exclusively from web UI "Run" button |

### Files Modified

| File | Change |
|------|--------|
| `.agents/SYSTEM/FEATURE-SPLIT.md` | Removed webhook triggers, scheduled execution, CLI from Core. Added Telegram Bot, Webhook triggers, Scheduled execution to Cloud SaaS table. Added guidelines #6 (no bot/trigger integrations) and #7 (no CLI/SDK). Updated date. |
| `.agents/skills/scope-validator/SKILL.md` | Added Cloud-Only Features table. Added Rule 5: Bot/Trigger Check. Added Telegram/webhook FAQ entries. Updated Quick Reference with cloud-only features and "Triggers: UI only" note. |
| `.agents/SYSTEM/ARCHITECTURE.md` | Added UI-only trigger note to data flow diagram. Fixed Output node categories (removed WebhookOutput, APIOutput). Replaced SDK package with actual packages (prompts, workflows). |
| `.agents/TASKS/INBOX.md` | Marked Telegram Bot task as moved to Cloud SaaS. Struck through Telegram bot reference in UGC Factory task. |

### Stale References Noted

Grep found webhook/telegram references in these files (left as-is since they're historical records):
- `.agents/SESSIONS/2026-01-21.md` — Session 22 documents the webhook removal process
- `.agents/SESSIONS/2026-01-14.md` — Historical webhook implementation
- `.agents/PRDS/telegram-bot-core.md` — Superseded PRD (core telegram bot was deleted)
- `.agents/PRDS/telegram-bot-workflow.md` — Original PRD, cloud portion still valid
- `.agents/PRDS/kling-motion-control.md` — References Replicate API webhooks (internal mechanism, not external triggers)
- `.agents/PRDS/ugc-factory-*.md` — Historical references to Telegram distribution

### Patterns Established

- Core scope docs now consistently state: **UI-only trigger model**
- Three-doc consistency: FEATURE-SPLIT, scope-validator SKILL, and ARCHITECTURE all align
- Cloud SaaS table in FEATURE-SPLIT is the authoritative scope boundary

---

## Session 2: Stop Tracking next-env.d.ts

**Goal:** Remove auto-generated `next-env.d.ts` files from git tracking in core repo (cloud already ignores them).

### Tasks Completed

1. Added `next-env.d.ts` to `.gitignore` under a new "Next.js auto-generated" section
2. Removed both tracked files from git index: `next-env.d.ts` and `apps/web/next-env.d.ts`
3. Committed as `3a5847e` — `chore: stop tracking next-env.d.ts`

### Files Modified

| File | Change |
|------|--------|
| `.gitignore` | Added `next-env.d.ts` to ignore list |
| `next-env.d.ts` | Removed from git tracking (file still exists locally) |
| `apps/web/next-env.d.ts` | Removed from git tracking (file still exists locally) |

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| Ignore pattern `next-env.d.ts` (no path prefix) | Catches all instances across the repo, matching cloud repo's approach |

### Status
- Committed, not pushed

---

## Session 3: Refactor Distribution Node Registry

**Goal:** Replace hardcoded distribution node injection with a `DistributionNodeRegistry` service. Remove concrete node coupling from `ProcessingProcessor`.

### Tasks Completed

1. Created `DistributionNodeRegistry` injectable service with `register()`, `get()`, `getRegisteredTypes()` methods
2. Updated 3 output nodes to self-register via `OnModuleInit` lifecycle hook
3. Simplified `queue.module.ts` — removed 3 string token aliases, added single registry provider + alias
4. Refactored `ProcessingProcessor` — replaced 3 concrete node injections with single registry injection, replaced switch-based lookup with registry lookup

### Files Created

| File | Purpose |
|------|---------|
| `apps/api/src/nodes/distribution/distribution-node-registry.ts` | Registry service — `Map<nodeType, { node, platform }>` |

### Files Modified

| File | Change |
|------|--------|
| `apps/api/src/nodes/distribution/telegram-output-node.ts` | Added `OnModuleInit`, injects registry, registers as `telegramPost` → `telegram` |
| `apps/api/src/nodes/distribution/discord-output-node.ts` | Added `OnModuleInit`, injects registry, registers as `discordPost` → `discord` |
| `apps/api/src/nodes/distribution/google-drive-output-node.ts` | Added `OnModuleInit`, injects registry, registers as `googleDriveUpload` → `google_drive` |
| `apps/api/src/modules/queue.module.ts` | Added `DistributionNodeRegistry` provider + string alias; removed 3 individual node aliases |
| `apps/api/src/processors/processing.processor.ts` | Replaced 3 node injections with single `DistributionNodeRegistry` injection; replaced switch with `registry.get()` |

### Decisions Made

| Decision | Rationale |
|----------|-----------|
| Self-registration via `OnModuleInit` | Nodes own their registration — adding a new node = 1 file + 1 line in module providers |
| `forwardRef` on registry injection in nodes | Avoids circular dependency since registry and nodes are in the same module |
| Keep concrete nodes as providers in module | NestJS DI still needs to instantiate them for `OnModuleInit` to fire |
| Registry uses `Map<string, { node, platform }>` | Simple lookup, no switch statements, O(1) access |

### Patterns Established

- Distribution nodes self-register with `DistributionNodeRegistry` via `OnModuleInit`
- `ProcessingProcessor` has zero knowledge of concrete distribution node types
- Adding a new distribution platform = 1 new file (node with `OnModuleInit`) + 1 line in `queue.module.ts` providers

### Status
- All changes made, zero TS diagnostics
- Not committed, not pushed
