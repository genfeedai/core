# Session: 2026-02-12

## Session 1: Avatar Video Workflow Template

**Duration:** ~15 min
**Branch:** master (uncommitted)

### Tasks Completed

1. **Created Avatar Video workflow template** — end-to-end AI avatar video pipeline
   - Script generation (LLM) → TTS → Lip Sync → Video Stitch → Subtitles → Download
   - 8 nodes, 8 edges
   - LLM output fans to both TTS (voice) and Subtitle (captions) — no redundant transcription step

2. **Registered template in seed file** — added to `SYSTEM_TEMPLATES` array in `templates.seed.ts`
   - Category: `TemplateCategory.FULL_PIPELINE`

3. **Renamed from "Wisenode Avatar Video" to "Avatar Video"** — made it a generic reusable template instead of client-specific

### Files Created
- `apps/api/src/templates/avatar-video.json` — standalone importable JSON template

### Files Modified
- `apps/api/src/templates/templates.seed.ts` — added Avatar Video template entry at end of `SYSTEM_TEMPLATES` array

### Key Decisions
- **Used `download` node** (not `output`) — matches the plan and is a valid node type in the registry
- **Category: FULL_PIPELINE** — this is a multi-step end-to-end pipeline, not just video
- **No motionControl node** — lip sync already produces a talking avatar; motionControl is for camera/body motion from reference video, doesn't chain cleanly after lip sync
- **LLM → Subtitle direct edge** — script text IS the spoken text, no need for a separate transcribe step
- **Renamed to generic "Avatar Video"** — user decided it's a reusable template, not client-specific

### Node Defaults
| Node | Key Config |
|------|------------|
| LLM | `claude-4.5-sonnet`, scriptwriter system prompt |
| TTS | ElevenLabs, `rachel` voice, stability 0.5, speed 1.0 |
| LipSync | `sync/lipsync-2-pro`, loop sync mode |
| VideoStitch | `crossfade` transition, 0.5s duration |
| Subtitle | `modern` style, bottom position, white on dark bg |

### Handle ID Verification
All source/target handles verified against `packages/types/src/nodes/registry.ts`:
- prompt → `text` out, llm → `prompt` in / `text` out
- textToSpeech → `text` in / `audio` out
- imageInput → `image` out
- lipSync → `image`, `video`, `audio` in / `video` out
- videoStitch → `videos` in / `video` out
- subtitle → `video`, `text` in / `video` out
- download → `image`, `video` in

### Status
- All changes uncommitted on master
- No tests written (template is data-only JSON/object)
- Not yet verified in running dev server

---

## Session 2: AI Agent Setup Overhaul (8 Phases)

**Duration:** ~30 min
**Branch:** master (uncommitted)

**Goal**: Improve AI agent setup inspired by OpenAI Skills/Shell/Compaction patterns — reduce context bloat, add skill routing, consolidate overlapping skills, create custom agents.

**Status**: All 8 phases complete.

### Tasks Completed

#### Phase 1: Rewrote `core/CLAUDE.md` — Self-Sufficient
- **Before**: 30 lines (pointers to hidden .agents/ files)
- **After**: 121 lines — self-contained with tech stack, commands, 5 critical rules, architecture patterns, node system, queue architecture, skill routing table, common pitfalls, deep reference links

#### Phase 2: Slimmed Workspace `CLAUDE.md`
- **Before**: 273 lines (infra, full trees, cloud/ commands, duplicated patterns)
- **After**: 37 lines — repo table (names only), cross-repo rules, documentation pointers
- **Reduction**: 86%

#### Phase 3: Added Routing Headers to All 12 Skills
Added standardized `## Routing` sections ("USE when" / "DO NOT use when" / "Expected outputs") to: `bugfix`, `openclaw-integration`, `node-creator`, `workflow-creator`, `prompt-generator`, `onboarding`, `react-flow`, `react-flow-advanced`, `react-flow-code-review`, `scope-validator`

#### Phase 4: Consolidated React Flow Skills (5 -> 3)
- **Kept + expanded**: `react-flow` (merged "When to Use", perf scaling, CSS classes, common props)
- **Kept + expanded**: `react-flow-code-review` (merged perf scaling table)
- **Kept**: `react-flow-advanced`
- **Deleted**: `react-flow-implementation` (symlink + source dir)
- **Deleted**: `react-flow-architecture` (symlink + source dir)

#### Phase 5: Expanded Bugfix Skill
- **Before**: 11 lines -> **After**: 66 lines — routing header, 8-step workflow, 6 common root causes

#### Phase 6: Created Infrastructure Reference Skill (New)
- 133 lines — EC2 instances, SSH, ports, repo table with git URLs, cloud/ commands, workspace dir tree
- Receives content moved out of workspace CLAUDE.md

#### Phase 7: Created 3 Custom Agents (New)
- `feature-builder.md` — implements features from PRD with pre-implementation checklist, TDD, pattern matching
- `bug-investigator.md` — systematic root cause analysis, traces data flow, common root causes
- `code-reviewer.md` — read-only review against all project standards

#### Phase 8: Slimmed `generate-workflow` Command
- **Before**: 232 lines -> **After**: 76 lines — delegates to `workflow-creator` skill for reference data

### Files Created
- `.claude/skills/infra-reference/SKILL.md` (133 lines)
- `.claude/agents/feature-builder.md` (43 lines)
- `.claude/agents/bug-investigator.md` (38 lines)
- `.claude/agents/code-reviewer.md` (60 lines)

### Files Modified
- `CLAUDE.md` — rewrite (30 -> 121 lines)
- `/genfeedai/CLAUDE.md` — rewrite (273 -> 37 lines)
- `.claude/skills/bugfix/SKILL.md` — rewrite (11 -> 66 lines)
- `.claude/skills/openclaw-integration/SKILL.md` — added routing header
- `.agents/skills/node-creator/SKILL.md` — added routing header
- `.agents/skills/workflow-creator/SKILL.md` — added routing header
- `.agents/skills/prompt-generator/SKILL.md` — added routing header
- `.agents/skills/onboarding/SKILL.md` — added routing header
- `.agents/skills/react-flow/SKILL.md` — added routing + merged content
- `.agents/skills/react-flow-advanced/SKILL.md` — added routing header
- `.agents/skills/react-flow-code-review/SKILL.md` — added routing + perf table
- `.agents/skills/scope-validator/SKILL.md` — standardized routing
- `.claude/commands/generate-workflow.md` — rewrite (232 -> 76 lines)

### Files Deleted
- `.agents/skills/react-flow-implementation/` (entire dir)
- `.agents/skills/react-flow-architecture/` (entire dir)
- `.claude/skills/react-flow-implementation` (symlink)
- `.claude/skills/react-flow-architecture` (symlink)

### Key Decisions
1. **Self-sufficient core/CLAUDE.md** — surfaced critical rules + architecture directly
2. **Skill routing table in CLAUDE.md** — central "Need X? Use Y, NOT Z" table
3. **React Flow 5->3** — merged implementation + architecture content into remaining skills
4. **Workspace CLAUDE.md as slim pointer** — each repo self-sufficient
5. **generate-workflow delegates to skill** — removed ~180 lines of duplicated tables

### Patterns Established
- Skill routing header template: `## Routing` with USE/DO NOT/Expected
- Agent files in `.claude/agents/` with YAML frontmatter
- Two-layer architecture: slim always-loaded context + on-demand deep skills

### Status
- All changes uncommitted on master
- Verification recommended: fresh session to confirm CLAUDE.md loads cleanly

---

## Session 3: Transcribe Node Backend Implementation

**Duration:** ~10 min
**Branch:** master (uncommitted)

### Tasks Completed

1. **Implemented full Transcribe node backend** — wired up Replicate's Whisper model (`openai/whisper`) so the Transcribe node (which already existed in frontend) now has complete backend processing.

### Files Modified (5)

| File | Change |
|------|--------|
| `packages/types/src/enums.ts:48` | Added `TRANSCRIBE = 'transcribe'` to `ProcessingNodeType` enum |
| `apps/api/src/queue/queue.constants.ts:115` | Added `transcribe: QUEUE_NAMES.PROCESSING` to `NODE_TYPE_TO_QUEUE` |
| `apps/api/src/interfaces/job-data.interface.ts:195-256` | Added `TranscribeJobData` interface, added to `ProcessingJobData` union |
| `apps/api/src/services/replicate.service.ts` | Added `whisper` to `MODELS`, `TranscribeInput` interface, `transcribeAudio()` method |
| `apps/api/src/processors/processing.processor.ts` | Added import, `TRANSCRIBE` to `replicateNodeTypes`, switch case, text output branch in polling, `handleTranscribe()` method |

### Key Decisions

1. **Whisper accepts video directly** — no FFmpeg `extractAudio` pre-processing needed; Whisper extracts audio internally
2. **Input priority**: `inputAudio` (connection) > `audio` (direct) > `inputVideo` (connection) > `video` (direct)
3. **Text output format**: `{ text }` matching `llm.processor.ts` pattern — downstream Subtitle node receives via `inputText`
4. **Poll config**: Uses `POLL_CONFIGS.processing.image` (Whisper is fast, similar to image processing)
5. **Language handling**: When `language === 'auto'`, passes `undefined` to let Whisper auto-detect

### Patterns Reused

- `convertLocalUrlToBase64()` for Replicate URL handling
- `checkExistingPrediction()` for retry support
- `replicatePollerService.pollForCompletion()` for async result polling
- `executionsService.createJob()` / `updateNodeResult()` for job lifecycle
- Text output pattern from `llm.processor.ts:82`

### Not Modified (Already Existed)

- `packages/types/src/nodes/registry.ts` — transcribe node definition (line 254)
- `packages/types/src/nodes/ai-nodes.ts` — `TranscribeNodeData` interface (line 239)
- `packages/types/src/nodes/union.ts` — already includes `TranscribeNodeData`
- `packages/workflow-ui/src/nodes/ai/TranscribeNode.tsx` — frontend component

### Enables Workflow

`Avatar Video → Transcribe → (text) → Subtitles ← (video) ← Avatar Video → Export`

### Status

- All changes uncommitted on master
- Not yet verified in running dev server
- No tests written (follows existing processor patterns)

---

## Session 4: Fix Job Recovery Service Aggressively Recovering Non-Stalled Jobs

**Duration:** ~10 min
**Branch:** master (uncommitted)

### Problem

On server startup, `JobRecoveryService` was recovering 146 "stalled" jobs and re-enqueueing them — but most weren't actually stalled. The same job would get enqueued 6+ times in 3 seconds, creating duplicate cascades. No guards against false positives existed.

### Root Causes Fixed

1. No check if parent Execution was already completed/failed/cancelled
2. `queueJobModel.create()` in enqueue methods produced duplicate MongoDB docs per bullJobId
3. No BullMQ existence check before re-enqueueing
4. No max recovery attempts — infinite recovery loop

### Files Modified (5)

| File | Change |
|------|--------|
| `apps/api/src/queue/queue.constants.ts` | Added `MAX_RECOVERY_ATTEMPTS = 3` constant |
| `apps/api/src/schemas/queue-job.schema.ts` | Added `recoveryCount: number` field (default 0) |
| `apps/api/src/services/queue-manager.service.ts` | Added `isJobActiveInBullMQ()` method; converted `create()` to `findOneAndUpdate(upsert)` in both `enqueueWorkflow()` and `enqueueNode()` |
| `apps/api/src/services/job-recovery.service.ts` | Injected `ExecutionsService`; added `recoveryCount < MAX_RECOVERY_ATTEMPTS` filter to query; batch execution status check (skips terminal executions); 3 guards in `recoverJob()`: BullMQ active check, max attempts → DLQ, `$inc` recoveryCount; reset `recoveryCount: 0` on DLQ retry |
| `apps/api/src/modules/queue.module.ts` | Added compound index `{ status, updatedAt, movedToDlq, recoveryCount }` for recovery query; added unique index on `bullJobId` |

### Key Decisions

1. **Upsert keyed on `bullJobId`** — deterministic IDs (`workflow-${executionId}` or `${executionId}-${nodeId}`) prevent duplicate MongoDB documents
2. **3 recovery attempt max** — after 3 failed recoveries, job moves to DLQ
3. **Execution status batch check** — deduplicates executionIds, fetches statuses, bulk-marks terminal execution jobs as COMPLETED
4. **BullMQ active check** — if job is still `active | waiting | delayed` in Redis, refresh heartbeat instead of re-enqueueing
5. **Not-found executions treated as terminal** — orphaned jobs don't get recovered endlessly
6. **`retryFromDlq()` resets `recoveryCount: 0`** — fresh recovery budget on manual DLQ retry

### What Was NOT Changed

- BullMQ configuration, retry settings, or backoff strategies
- Heartbeat mechanism (works fine for Replicate processors)
- Normal enqueue flow for new executions
- DLQ retry logic (`retryFromDlq`) — only added `recoveryCount: 0` reset
- `recoverExecution()` manual recovery endpoint

### Status

- All changes uncommitted on master
- Not yet verified in running dev server
- Linter auto-formatted one file (line wrapping in `job-recovery.service.ts`)
