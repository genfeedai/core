# Session: 2026-02-04

## Session 1: Port node-banana Features to Genfeed Core

**Branch:** `master`
**Commit:** `2320ee8` — `feat: port node-banana features — new nodes, pause edges, AI editing`

### Tasks Completed

1. **Phase 1: 3 New Node Types** — PromptConstructor, OutputGallery, ImageCompare
2. **Phase 2: Pause Edges** — Edge breakpoints with server-side pause/resume
3. **Phase 3: AI Editing System** — Chat tools, snapshots, edit operations

### Files Created (13)

- `apps/web/src/components/nodes/input/PromptConstructorNode.tsx` — Template-based prompt with @variable interpolation
- `apps/web/src/components/nodes/processing/OutputGalleryNode.tsx` — Thumbnail grid with lightbox
- `apps/web/src/components/nodes/processing/ImageCompareNode.tsx` — A/B comparison with react-compare-slider
- `apps/web/src/components/canvas/PauseEdge.tsx` — Custom React Flow edge with pause icon
- `apps/web/src/hooks/usePromptAutocomplete.ts` — @ trigger, filtering, keyboard nav
- `apps/web/src/lib/chat/editOperations.ts` — Batch workflow edit operations
- `apps/web/src/lib/chat/contextBuilder.ts` — Binary-stripped workflow context for LLM
- `apps/web/src/lib/chat/subgraphExtractor.ts` — Scoped editing for selected nodes
- `apps/web/src/lib/chat/tools.ts` — AI SDK tool definitions with dynamic NODE_DEFINITIONS
- `apps/web/src/store/workflow/slices/snapshotSlice.ts` — Capture/revert AI change snapshots
- `apps/web/src/store/workflow/slices/chatSlice.ts` — Chat message state + applyChatEditOperations
- `apps/web/src/components/panels/ChatPanel.tsx` — Chat UI panel
- `apps/web/src/components/toolbar/SnapshotRevertBanner.tsx` — Floating revert banner

### Files Modified (16)

- `packages/types/src/nodes/base.ts` — Added `promptConstructor`, `outputGallery`, `imageCompare` to NodeType
- `packages/types/src/nodes/input-nodes.ts` — Added `AvailableVariable`, `PromptConstructorNodeData`
- `packages/types/src/nodes/processing-nodes.ts` — Added `OutputGalleryNodeData`, `ImageCompareNodeData`
- `packages/types/src/nodes/union.ts` — Added new types to union + `hasPause` to `WorkflowEdgeData`
- `packages/types/src/nodes/registry.ts` — Added NODE_DEFINITIONS + NODE_ORDER entries for 3 new nodes
- `apps/web/src/components/nodes/index.ts` — Registered 3 new node components in nodeTypes
- `apps/web/src/components/nodes/input/index.ts` — Added PromptConstructorNode export
- `apps/web/src/components/nodes/processing/index.ts` — Added OutputGalleryNode, ImageCompareNode exports
- `apps/web/src/store/workflow/types.ts` — Added SnapshotSlice + ChatSlice to WorkflowStore, toggleEdgePause to EdgeActions
- `apps/web/src/store/workflow/workflowStore.ts` — Composed snapshotSlice + chatSlice
- `apps/web/src/store/workflow/slices/edgeSlice.ts` — Added toggleEdgePause implementation
- `apps/web/src/store/execution/types.ts` — Added pausedAtNodeId to ExecutionState
- `apps/api/src/services/executions.service.ts` — Added promptConstructor to passthrough maps + setPausedAtNodeId method
- `apps/api/src/services/queue-manager.service.ts` — Added pause edge check in continueExecution + resumeExecution method
- `apps/web/package.json` — Added ai, react-compare-slider, zod dependencies
- `bun.lock` — Updated lockfile

### Key Decisions

1. **PromptConstructor uses `variableName` from PromptNodeData** — Connected prompt nodes expose their `variableName` field for @-variable resolution
2. **OutputGallery/ImageCompare extract images from upstream nodes** — Direct node data access (not execution results) for real-time preview
3. **Pause edges are server-side** — `hasPause` on edge data causes queue manager to set execution status to 'paused' and store `pausedAtNodeId`
4. **Chat tools generate valid types dynamically** — Uses `Object.keys(NODE_DEFINITIONS)` instead of hardcoding node types
5. **Snapshot auto-clears after 3 manual changes** — Matches node-banana pattern
6. **Biome lint fixes** — Template literals required over string concat; map callbacks need explicit return type

### Patterns Established

- New node types follow: types → base.ts → union.ts → registry.ts → component → barrel export → nodeTypes map
- Passthrough nodes need entries in both `PASSTHROUGH_NODE_TYPES` and `PASSTHROUGH_OUTPUT_MAP`
- Store slices composed via type assertion: `...(createSlice as unknown as typeof createNodeSlice)(...args)`

### Test Results

- **Zero regressions** — All pre-existing failures confirmed pre-existing via git stash verification
- Types: 22/22 pass
- Core: 80/80 pass
- Workflow store: 23/24 (1 pre-existing: loadWorkflow isDirty expectation)
- API services: 50/52 (2 pre-existing: cost calculation tests)

### Incomplete / Next Steps

- ChatPanel needs actual AI SDK integration (`useChat` from `@ai-sdk/react`) — currently only has message UI
- PauseEdge needs to be registered as a custom edge type in React Flow's `edgeTypes` prop
- Edge context menu needs "Toggle Pause" option added
- `react-compare-slider` dependency installed but may need version pinning
- No tests written for new features (per TDD policy, should be added)

---

## Session 2: Add Image Pagination to NodeDetailModal

**Branch:** `master` (uncommitted)

### Task Completed

1. **Image pagination in NodeDetailModal** — Added prev/next navigation for multi-image outputs in the lightbox modal

### Files Modified (4)

- `apps/web/src/lib/utils/mediaExtraction.ts` — Added `urls?: string[]` to `MediaInfo` interface; `imageGen` case now populates `urls` from `outputImages` array
- `apps/web/src/store/uiStore.ts` — Added `nodeDetailStartIndex` state + param to `openNodeDetailModal`; reset on close
- `apps/web/src/components/nodes/NodeDetailModal.tsx` — Added `currentIndex` state, `goToPrevious`/`goToNext` handlers, `ArrowLeft`/`ArrowRight` keyboard shortcuts, chevron nav buttons, image counter pill ("1 / N"), download uses `displayUrl`
- `apps/web/src/components/nodes/ai/ImageGenNode.tsx` — `handleExpand` now passes `selectedPreview ?? 0` as `startIndex` so modal opens on clicked thumbnail

### Key Decisions

1. **`displayUrl` derived from `urls[currentIndex]`** — Falls back to `mediaInfo.url` for single-image nodes, no breaking changes
2. **Nav arrows hidden at boundaries** — Left hidden on first image, right hidden on last (no wrapping)
3. **Zoom/pan resets on image change** — Switching images resets to 1x zoom and centered pan
4. **Counter pill at bottom center** — Only shown when `urls.length > 1`
5. **Download filename includes index** — Multi-image downloads get `_1`, `_2` suffix

### Incomplete / Next Steps

- Changes are uncommitted — ready to commit when requested
- No tests written for pagination logic

---

## Session 3: Move MotionControlNode Generate Button to Header

**Branch:** `master` (uncommitted)

### Task Completed

1. **Moved Generate button from body to header** — MotionControlNode now matches ImageGenNode/VideoGenNode pattern with Generate/Stop toggle in `headerActions`

### Files Modified (1)

- `apps/web/src/components/nodes/ai/MotionControlNode.tsx`
  - Replaced `Loader2` import with `Square` from lucide-react
  - Added `handleStop` destructured from `useNodeExecution`
  - Rewrote `headerActions` memo: expand button + Generate/Stop toggle (destructive "Generating" with Square icon during processing, "Generate" with Play icon when idle)
  - Added `hideStatusIndicator` prop to BaseNode (prevents duplicate stop button)
  - Removed body Generate button block (`{!nodeData.outputVideo && ...}`)
  - Kept help text and video requirement hints in body

### Key Decisions

1. **Exact pattern match with ImageGenNode** — Same Generate/Stop toggle, same variant logic (`default` when canGenerate, `secondary` when disabled), same `fill-current` icon styling
2. **`hideStatusIndicator` required** — Without it, BaseNode renders its own stop button alongside the headerActions one
3. **Help text preserved in body** — Users still see "Connect an image..." guidance when inputs are missing

### Incomplete / Next Steps

- Changes are uncommitted — ready to commit when requested

---

## Session 4: Fix Motion Control Generate Button Not Activating

**Branch:** `master` (uncommitted)

### Root Cause

`getConnectedInputs()` in `persistenceSlice.ts` and `extractOutputValue()` in `useCanGenerate.ts` only checked `outputVideo` for the video handle type. Video Input nodes store their data as `video` (not `outputVideo`). Image and audio handles already had fallbacks (`image`, `audio`) but video was missing — so any node consuming a Video Input node's output would fail the `hasConnectedData` check and disable Generate.

### Files Modified (4)

- `apps/web/src/store/workflow/slices/persistenceSlice.ts` — Added `sourceData.video` fallback for video handle in `getConnectedInputs()`, added `video?: string` to typed cast
- `apps/web/src/hooks/useCanGenerate.ts` — Added `data.video` fallback in `extractOutputValue()` for video handle; removed unused `connectedNodeData` variable binding
- `apps/web/src/components/nodes/NodeDetailModal.tsx` — Added biome-ignore for intentional `nodeDetailNodeId` dependency (triggers reset when different node opens)
- `apps/web/src/components/toolbar/BottomBar.tsx` — Removed unused `lastFailedNodeId` import (pre-existing lint issue, cleaned up by linter)

### Key Decisions

| Decision | Rationale |
|----------|-----------|
| `outputVideo ?? video` fallback pattern | Matches existing `outputImage ?? image` and `outputAudio ?? audio` patterns for other handle types |
| Keep `nodeDetailNodeId` in useEffect deps | Opening two different nodes both at startIndex 0 needs to reset zoom/pan — removing the dep would break this |
| Remove `connectedNodeData` binding, keep selector | The `useWorkflowStore(useShallow(...))` subscription still drives reactivity; the variable was never referenced |

### Patterns Established

- All handle types in `getConnectedInputs` and `extractOutputValue` now consistently check both `output{Type}` and raw `{type}` field names

### Incomplete / Next Steps

- Changes are uncommitted — ready to commit when requested

---

## Session 5: Fix OutputGalleryNode Not Showing All Connected Images

**Branch:** `master` (uncommitted)

### Root Cause

`OutputGalleryNode.tsx` had hardcoded type checks for only 3 node types (`imageInput`, `annotation`, `imageGen`). Any other image-producing node connected to the gallery (upscale, reframe, resize, videoFrameExtract, etc.) was silently ignored — their images never appeared.

### Files Modified (1)

- `apps/web/src/components/nodes/processing/OutputGalleryNode.tsx`
  - Replaced hardcoded node-type-specific image extraction with generic field checks
  - Now checks `outputImages` (array) → `outputImage` (single) → `image` (input nodes) on **any** connected source node
  - Eliminates need to update this component when new image-producing node types are added

### Key Decisions

| Decision | Rationale |
|----------|-----------|
| Generic field-based extraction over type-based | Future-proof — new node types automatically work without updating OutputGalleryNode |
| Check `outputImages` before `outputImage` | Multi-output nodes (imageGen) store results in array; single field may be null |
| Early return after first match | A node won't have both `outputImages` and `outputImage` populated simultaneously |

### Patterns Established

- Image extraction from connected nodes should use field-based checks (`outputImages` → `outputImage` → `image`), not node-type switches

---

## Session 6: Fix Downstream Propagation for Multi-Image Nodes (Upscale Connection Bug)

**Branch:** `master` (uncommitted)

### Root Cause

`getNodeOutput()` in `nodeSlice.ts` never checked the `outputImages` array field. When an `imageGen` node produces multiple images, it stores them in `outputImages: ["url1", "url2", "url3"]` while `outputImage` remains `null`. Since `getNodeOutput` only checked `outputImage` (which was null), `propagateOutputsDownstream()` had nothing to propagate — so downstream nodes like Upscale never received `inputImage` and showed "Connect an image or video input" despite being wired.

### Files Modified (1)

- `apps/web/src/store/workflow/slices/nodeSlice.ts`
  - Added `outputImages` array check before the existing `outputImage` check in `getNodeOutput()`
  - Returns first image from `outputImages` array for downstream propagation
  - Preserves all existing fallback logic for other output types

### Key Decisions

| Decision | Rationale |
|----------|-----------|
| Check `outputImages` before `outputImage` in `getNodeOutput` | Multi-output imageGen nodes have `outputImage: null` with all results in `outputImages` — checking single field first would always return null |
| Propagate `outputImages[0]` (first image) | Downstream nodes like Upscale accept single image input — first image is the sensible default |

### Patterns Established

- `getNodeOutput()` is the single source of truth for what a node "outputs" for downstream propagation — any new output field must be added here
- Multi-value outputs (arrays) should be checked before their single-value counterparts

### Incomplete / Next Steps

- Changes from Sessions 2-6 are all uncommitted — ready to commit when requested
- Consider whether Upscale should support selecting which image from a multi-output node to upscale (currently always uses first)

---

## Session 7: Toolbar Cleanup + Upscale Input Propagation Fix

**Branch:** `master` (uncommitted)

### Tasks Completed

1. **Remove standalone "+ New" button from toolbar** — Redundant with WorkflowSwitcher dropdown footer
2. **Widen WorkflowSwitcher dropdown** — `w-72` → `w-80`, `max-h-64` → `max-h-80`
3. **Add "Open in Finder" button** — Opens workflow output folder in macOS Finder via API route
4. **Fix Upscale node not receiving `inputType` from propagation** — Generate button stayed disabled when connecting image nodes

### System Flow (Open in Finder)

```
Toolbar (FolderOpen button)
  → POST /api/open-folder { workflowId }
    → Resolve path: ../../data/workflows/{id}/output/
    → Fallback: ../../data/workflows/{id}/
    → exec('open "<path>"')
    → Finder opens
```

### Root Cause (Upscale Button Bug)

`mapOutputToInput()` in `nodeSlice.ts` set `inputImage` or `inputVideo` on upscale/reframe targets but did NOT set `inputType`. The component determines `hasInput` from `inputType` (via `??` fallback to checking `inputImage`/`inputVideo`). While the fallback works for fresh nodes, switching connection types (video→image) would leave stale `inputType: 'video'` — `??` sees non-nullish value and skips the `inputImage` check.

### Files Created (1)

- `apps/web/src/app/api/open-folder/route.ts` — POST endpoint, resolves output folder, runs `open` command (macOS)

### Files Modified (3)

- `apps/web/src/components/toolbar/Toolbar.tsx`
  - Removed `Plus` import (no longer used)
  - Removed divider + "+ New" button block (lines 411-427)
  - Added `handleOpenFolder` callback (POST to `/api/open-folder`)
  - Added "Open output folder" button with `FolderOpen` icon before Settings
- `apps/web/src/components/workflow/WorkflowSwitcher.tsx`
  - Dropdown width: `w-72` → `w-80` (288px → 320px)
  - Scrollable area: `max-h-64` → `max-h-80`
- `apps/web/src/store/workflow/slices/nodeSlice.ts`
  - Image → upscale/reframe: now returns `{ inputImage: output, inputVideo: null, inputType: 'image' }`
  - Video → upscale/reframe: now returns `{ inputVideo: output, inputImage: null, inputType: 'video' }`
  - Clears opposite input field to prevent stale data when switching connection types

### Key Decisions

| Decision | Rationale |
|----------|-----------|
| Set `inputType` + clear opposite field in `mapOutputToInput` | Matches existing `output` node pattern (lines 88-96); prevents stale state when switching connection types |
| Open output folder with workflow folder fallback | Output folder may not exist yet for new workflows |
| `FolderOpen` icon reused from existing import | Already imported for file menu's "Import Workflow" item |

### Known Issues

- `/api/open-folder` returns 404 on first test — needs debugging (path resolution may differ at runtime vs CLI)
- `getOutputType()` hardcodes upscale as image-only output — video upscale output won't propagate downstream correctly (secondary issue, rare flow)

### Incomplete / Next Steps

- Debug `/api/open-folder` 404 — check `process.cwd()` at runtime matches expected path
- All changes uncommitted — ready to commit when requested

---

## Session 8: Fix Node Drop Position on Canvas

**Branch:** `master` (uncommitted)

### Task Completed

1. **Fixed node drop position** — Nodes dragged from sidebar (NodePalette) now land at the correct canvas position regardless of pan/zoom state

### Root Cause

`handleDrop` in `WorkflowCanvas.tsx` calculated position using raw viewport-relative coordinates (`event.clientX - reactFlowBounds.left`) instead of converting screen coordinates to flow coordinates. When the canvas was panned or zoomed, nodes would land at incorrect positions.

### Files Modified (1)

- `apps/web/src/components/canvas/WorkflowCanvas.tsx`
  - Added `useReactFlow` to `@xyflow/react` import
  - Added `const reactFlow = useReactFlow()` hook call
  - Replaced manual viewport-relative calculation in `handleDrop` with `reactFlow.screenToFlowPosition({ x: event.clientX, y: event.clientY })`
  - Updated `handleDrop` dependency array to include `reactFlow`

### Key Decisions

| Decision | Rationale |
|----------|-----------|
| Use `screenToFlowPosition` over manual calc | Same approach used in `usePaneActions.ts:14` for context menu node placement — proven correct |
| No changes to `handleDragOver` | Only the position calculation was wrong; drag-over behavior is unrelated |

### Incomplete / Next Steps

- Changes are uncommitted — ready to commit when requested

---

## Session 9: Fix OutputGallery Store Propagation for Multi-Image Nodes

**Branch:** `master` (uncommitted)

### Root Cause

The OutputGallery node had no support in the store propagation system. `mapOutputToInput()` returned `null` for `targetType === 'outputGallery'`, so `propagateOutputsDownstream()` never wrote data to it. Additionally, `outputImages` (plural) was not included in the `hasOutputUpdate` trigger check, so when imageGen outputs arrived with `outputImages: [N urls]`, the propagation path didn't fire correctly for multi-image scenarios.

### Files Modified (1)

- `apps/web/src/store/workflow/slices/nodeSlice.ts`
  1. Added `'outputImages' in data` to `hasOutputUpdate` check (line 232) — triggers propagation when multi-image results arrive
  2. When `outputImages` is present in data, calls `propagateOutputsDownstream(nodeId)` without a single value — forces reading the full array from node state via `getNodeOutput()`
  3. Added `outputGallery` special case in BFS loop (before `mapOutputToInput` call) — collects ALL images from source's `outputImages` array (or falls back to single output string), deduplicates with `Set`, and merges into gallery's `images` field

### Key Decisions

| Decision | Rationale |
|----------|-----------|
| Special-case `outputGallery` before `mapOutputToInput` | `mapOutputToInput` returns `null` for gallery — adding a case there would still only propagate one image |
| Collect from `outputImages` array, not just first element | Gallery should display ALL generated images, not just the first |
| Deduplicate with `Set` + merge existing | Multiple sources can connect to same gallery; avoid duplicate URLs |
| No changes to `OutputGalleryNode.tsx` | Existing `useMemo` already merges `nodeData.images` with `connectedImages` and deduplicates |

### Incomplete / Next Steps

- All changes from Sessions 2-9 are uncommitted — ready to commit when requested
